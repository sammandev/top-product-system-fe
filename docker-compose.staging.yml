# Frontend Staging Docker Compose
# Frontend with Vite dev server (HMR) + Nginx reverse proxy
# Connects to backend API (must be running separately)

version: '3.8'

services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.dev
    image: ast-tools-frontend:dev
    container_name: ast-tools-frontend
    restart: unless-stopped
    ports:
      - "5173:5173"
    environment:
      - VITE_API_BASE_URL=/api
      - VITE_APP_TITLE=AST Parser - Staging
      - VITE_ENVIRONMENT=staging
    env_file:
      - .env.staging
    volumes:
      # Mount source code for HMR (Hot Module Replacement)
      - ./src:/app/src
      - ./public:/app/public
      - ./index.html:/app/index.html
      - ./vite.config.ts:/app/vite.config.ts
      - ./tsconfig.json:/app/tsconfig.json
      - ./tsconfig.app.json:/app/tsconfig.app.json
      - ./tsconfig.node.json:/app/tsconfig.node.json
      - ./package.json:/app/package.json:ro
      - ./.env.staging:/app/.env.staging:ro
      # Cache node_modules for faster startup
      - frontend_node_modules:/app/node_modules
    networks:
      - ast-tools-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5173/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    labels:
      - "com.ast-tools.service=frontend"
      - "com.ast-tools.environment=staging"
      - "com.ast-tools.hot-reload=enabled"

  nginx:
    image: nginx:alpine
    container_name: ast-tools-nginx
    restart: unless-stopped
    ports:
      - "9090:80"
      - "443:443"
    volumes:
      # Mount nginx config for easy updates
      - ./nginx/staging.conf:/etc/nginx/conf.d/default.conf:ro
      - nginx_logs:/var/log/nginx
    networks:
      - ast-tools-network
    depends_on:
      - frontend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "com.ast-tools.service=nginx"
      - "com.ast-tools.environment=staging"
    extra_hosts:
      # Allow nginx to access backend on host network
      - "host.docker.internal:host-gateway"

volumes:
  frontend_node_modules:
    driver: local
  nginx_logs:
    driver: local

networks:
  ast-tools-network:
    driver: bridge
    name: ast-tools-network
    external: true
